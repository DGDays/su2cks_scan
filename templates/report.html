<!DOCTYPE html>
<html>
<head>
    <title>–û—Ç—á–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - {{ scan.target }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; }
        pre { background: #f5f5f5; padding: 15px; overflow: auto; }
        .port { margin: 10px 0; padding: 10px; background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>–û—Ç—á–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {{ scan.target }}</h1>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ scan.status }}</p>
        <p><strong>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</strong> {{ scan.start_time }}</p>
        {% if scan.end_time %}
        <p><strong>–í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:</strong> {{ scan.end_time }}</p>
        {% endif %}
        
        {% if scan.results.nmap %}
        <div class="section">
            <h2>Nmap –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
            <h3>–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã:</h3>
            {% for port in scan.results.nmap.parsed_ports %}
            <div class="port">
                <strong>–ü–æ—Ä—Ç {{ port.port }} ({{ port.service }})</strong> - {{ port.state }}<br>
                –í–µ—Ä—Å–∏—è: {{ port.version }}
            </div>
            {% endfor %}
            
            <h3>–ü–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥ Nmap:</h3>
            <pre>{{ scan.results.nmap.raw_output }}</pre>
        </div>
        {% endif %}

        {% if scan.results.cve_analysis %}
        <div class="section">
            <h2>üîç –ê–Ω–∞–ª–∏–∑ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π CVE</h2>
            <p><strong>–ù–∞–π–¥–µ–Ω–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:</strong> {{ scan.results.cve_analysis.total_found }}</p>
            <p><strong>–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:</strong> {{ scan.results.cve_analysis.scan_time[:19] }}</p>
            
            {% for vuln in scan.results.cve_analysis.vulnerabilities %}
            <div style="margin: 15px 0; padding: 15px; border: 2px solid 
                {% if vuln.severity == 'CRITICAL' %}#dc3545
                {% elif vuln.severity == 'HIGH' %}#fd7e14
                {% elif vuln.severity == 'MEDIUM' %}#ffc107
                {% else %}#28a745{% endif %}; 
                border-radius: 5px; background: #f8f9fa;">
                <h4>
                    {{ vuln.cve_id }} 
                    <span style="color: 
                        {% if vuln.severity == 'CRITICAL' %}#dc3545
                        {% elif vuln.severity == 'HIGH' %}#fd7e14
                        {% elif vuln.severity == 'MEDIUM' %}#ffc107
                        {% else %}#28a745{% endif %}; 
                        font-weight: bold;">
                        [{{ vuln.severity }}]
                    </span>
                    {% if vuln.cvss_score != 'N/A' %}
                    <span style="color: #6c757d; font-size: 14px;">
                        (CVSS: {{ vuln.cvss_score }})
                    </span>
                    {% endif %}
                </h4>
                <p><strong>–°–µ—Ä–≤–∏—Å:</strong> {{ vuln.service }} {{ vuln.version }} (–ø–æ—Ä—Ç {{ vuln.port }})</p>
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ vuln.description }}</p>
                <p style="margin-top: 10px;">
                    <a href="https://nvd.nist.gov/vuln/detail/{{ vuln.cve_id }}" target="_blank" 
                    style="color: #007bff; text-decoration: none;">
                        üîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ NVD
                    </a>
                </p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        {% if scan.results.nikto %}
        <div class="section">
            <h2>Nikto –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ø–æ—Ä—Ç {{ scan.results.nikto.port }})</h2>
            <pre>{{ scan.results.nikto.output }}</pre>
        </div>
        {% endif %}
        
        {% if scan.results.gobuster %}
        <div class="section">
            <h2>Gobuster Dirs –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ø–æ—Ä—Ç {{ scan.results.gobuster.port }})</h2>
            <pre>{{ scan.results.gobuster.output }}</pre>
        </div>
        {% endif %}

        {% if scan.results.gobuster_vhost %}
        <div class="section">
            <h2>Gobuster Domains –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ø–æ—Ä—Ç {{ scan.results.gobuster_vhost.port }})</h2>
            <pre>{{ scan.results.gobuster_vhost.output }}</pre>
        </div>
        {% endif %}

    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π -->
    {% if scan.results.custom_scans %}
    <div class="section">
        <h2>üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        {% for key, custom_scan in scan.results.custom_scans.items() %}
        <div style="margin: 15px 0; padding: 15px; border: 2px solid #28a745; border-radius: 5px; background: #f8fff9;">
            <h4>üéØ 
                {% if custom_scan.scan_type == 'dir' %}–ü–æ–∏—Å–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
                {% elif custom_scan.scan_type == 'vhost' %}–ü–æ–∏—Å–∫ vhost
                {% elif custom_scan.scan_type == 'sqlmap' %}SQL Injection Test
                {% else %}{{ custom_scan.scan_type }}{% endif %}
                ({{ custom_scan.timestamp[:19] }})
            </h4>
            
            {% if custom_scan.scan_type == 'dir' or custom_scan.scan_type == 'vhost' %}
            <p><strong>–°–ª–æ–≤–∞—Ä—å:</strong> {{ custom_scan.wordlist_used }}</p>
            <p><strong>–ü–æ—Ä—Ç:</strong> {{ custom_scan.port }}</p>
            {% elif custom_scan.scan_type == 'sqlmap' %}
            <p><strong>–ö–æ–º–∞–Ω–¥–∞:</strong> <code>sqlmap {{ custom_scan.commands }}</code></p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {% if custom_scan.success %}‚úÖ –£—Å–ø–µ—à–Ω–æ{% else %}‚ùå –û—à–∏–±–∫–∞{% endif %}</p>
            <p><strong>–ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞:</strong> {{ custom_scan.returncode }}</p>
            {% endif %}
            
            <div style="margin-top: 10px;">
                <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong>
                <pre style="background: #f5f5f5; padding: 10px; border-radius: 3px; max-height: 300px; overflow-y: auto;">{{ custom_scan.output or '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤' }}</pre>
            </div>
            
            {% if custom_scan.scan_type == 'sqlmap' and custom_scan.error %}
            <div style="margin-top: 10px;">
                <strong>–û—à–∏–±–∫–∏:</strong>
                <pre style="background: #fff5f5; padding: 10px; border-radius: 3px; max-height: 200px; overflow-y: auto;">{{ custom_scan.error }}</pre>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="customScanModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 400px;">
        <h3>üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        
        <div style="margin: 15px 0;">
            <label>–¢–∏–ø —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
            <select id="scanType" style="width: 100%; padding: 8px; margin: 5px 0;">
                <option value="dir">Gobuster Dir (–ø–æ–∏—Å–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π)</option>
                <option value="vhost">Gobuster Vhost (–ø–æ–∏—Å–∫ –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤)</option>
                <option value="sqlmap">SQLMap (—Ç–µ—Å—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π)</option>
            </select>
        </div>

                <!-- –ü–æ–ª—è –¥–ª—è Gobuster (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã) -->
        <div id="gobusterFields" style="margin: 15px 0; display: none;">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–≤–∞—Ä—å:</label>
            <input type="file" id="customWordlistFile" 
                accept=".txt,.lst"
                style="width: 100%; padding: 8px; margin: 5px 0;">
            <small>–í—ã–±–µ—Ä–∏—Ç–µ .txt —Ñ–∞–π–ª —Å–æ —Å–ª–æ–≤–∞—Ä–µ–º</small>
            
            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ -->
            <div id="selectedFileInfo" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                <strong>–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª:</strong> <span id="fileName"></span>
            </div>
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è SQLMap (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã) -->
        <div id="sqlmapFields" style="margin: 15px 0; display: none;">
            <label>–ö–æ–º–∞–Ω–¥—ã SQLMap (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <input type="text" id="sqlmapCustomCommands" 
                placeholder="-u http://target.com/page.php?id=1 --batch --level=1"
                style="width: 100%; padding: 8px; margin: 5px 0;">
            <small>–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: -u {target} --batch --level=1 --risk=1</small>
        </div>

        <!-- –ü–æ–ª–µ –ø–æ—Ä—Ç–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è Gobuster) -->
        <div id="portField" style="margin: 15px 0; display: none;">
            <label>–ü–æ—Ä—Ç:</label>
            <input type="number" id="customPort" value="80" style="width: 100%; padding: 8px; margin: 5px 0;">
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="startCustomScan()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å
            </button>
            <button onclick="closeCustomScanModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ‚ùå –û—Ç–º–µ–Ω–∞
            </button>
        </div>
        
        <div id="customScanStatus" style="margin-top: 15px; display: none;"></div>
        
        <div style="margin-top: 15px; font-size: 12px; color: #666;">
            <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏:</strong><br>
            ‚Ä¢ /usr/share/wordlists/dirb/common.txt<br>
            ‚Ä¢ /usr/share/wordlists/dirb/big.txt<br>
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
<div style="margin: 20px 0;">
    <button onclick="openCustomScanModal()" style="padding: 12px 25px; background: #ffc107; color: black; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
        üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    </button>
</div>

<script>
// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
document.getElementById('scanType').addEventListener('change', function(e) {
    const scanType = e.target.value;
    const gobusterFields = document.getElementById('gobusterFields');
    const sqlmapFields = document.getElementById('sqlmapFields');
    const portField = document.getElementById('portField');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è
    gobusterFields.style.display = 'none';
    sqlmapFields.style.display = 'none';
    portField.style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    if (scanType === 'dir' || scanType === 'vhost') {
        gobusterFields.style.display = 'block';
        portField.style.display = 'block';
    } else if (scanType === 'sqlmap') {
        sqlmapFields.style.display = 'block';
    }
});

// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è
function openCustomScanModal() {
    document.getElementById('customScanModal').style.display = 'block';
    
    // –¢—Ä–∏–≥–≥–µ—Ä–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è
    const event = new Event('change');
    document.getElementById('scanType').dispatchEvent(event);
}

// –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ...
let currentTarget = "{{ scan.target }}";
let mainScanId = "{{ scan.id }}";
let selectedFilePath = '/usr/share/wordlists/dirb/common.txt';

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è Gobuster)
document.getElementById('customWordlistFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        selectedFilePath = '/usr/share/wordlists/' + file.name;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('selectedFileInfo').style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const statusDiv = document.getElementById('customScanStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `<div style="color: #28a745;">‚úÖ –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}</div>`;
        setTimeout(() => statusDiv.style.display = 'none', 2000);
    }
});

function closeCustomScanModal() {
    document.getElementById('customScanModal').style.display = 'none';
    document.getElementById('customScanStatus').style.display = 'none';
    document.getElementById('customWordlistFile').value = '';
    document.getElementById('selectedFileInfo').style.display = 'none';
    document.getElementById('sqlmapCustomCommands').value = '';
}

function startCustomScan() {
    const scanType = document.getElementById('scanType').value;
    const statusDiv = document.getElementById('customScanStatus');
    
    let requestData = {
        target: currentTarget,
        scan_type: scanType,
        main_scan_id: mainScanId
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    if (scanType === 'dir' || scanType === 'vhost') {
        const port = document.getElementById('customPort').value;
        requestData.port = parseInt(port);
        requestData.wordlist = selectedFilePath;
    } else if (scanType === 'sqlmap') {
        const commands = document.getElementById('sqlmapCustomCommands').value;
        // ‚≠ê –ü–†–û–°–¢–û –ü–ï–†–ï–î–ê–ï–ú –ö–û–ú–ê–ù–î–´ –ö–ê–ö –ï–°–¢–¨
        requestData.commands = commands;
    }
    
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div style="color: #007bff;">‚è≥ –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...</div>';
    
    fetch('/api/custom_scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'started') {
            statusDiv.innerHTML = '<div style="color: #28a745;">‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...</div>';
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            statusDiv.innerHTML = '<div style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞: ' + (data.error || 'Unknown error') + '</div>';
        }
    })
    .catch(error => {
        statusDiv.innerHTML = '<div style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞: ' + error + '</div>';
    });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
document.getElementById('customScanModal').addEventListener('click', function(e) {
    if (e.target.id === 'customScanModal') {
        closeCustomScanModal();
    }
});
</script>
        
        <a href="/">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–∫–∞–Ω–µ—Ä—É</a>
                    <div style="margin: 20px 0;">
    <button onclick="saveAsPdf()" style="padding: 10px 15px; background: #dc3545; color: white; border: none; cursor: pointer;">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PDF
    </button>
</div>

<script>
function saveAsPdf() {
    // –ü–æ–ª—É—á–∞–µ–º scan_id –∏–∑ URL
    const path = window.location.pathname;
    const scanId = path.split('/').pop();
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—Ç—á–µ—Ç–∞
    const isArpReport = path.includes('arp_report');
    const endpoint = isArpReport ? `/save_as_pdf/${scanId}` : `/save_as_pdf/${scanId}`;
    
    window.open(endpoint, '_blank');
}
</script>
    </div>

</body>
</html>